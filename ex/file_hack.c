#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>

#define MAX_TABLE_SIZE 0xff
#define MAGIC 0x12442154

char name[256]; //BSS

struct tableDesc
{
	unsigned int tag;
	unsigned int offset;
	unsigned char size;
} tableDesc;

struct fileHeader
{
	int magic;
	int totalLenght;
	unsigned int numberOfTables;
	struct tableDesc tables[];
} fileHeader;

void getUserName()
{
	printf("Enter your name (max 100 chars):\n");
	fflush(stdout);
	scanf("%256s",name);

	printf("Welcome: ");
	printf(name);  //
	fflush(stdout);

}
struct fileHeader * readFile()
{
	char path[256];
	printf("Enter file path (max path 256 chars):\n");
	scanf("%256s",path);
	
	
	FILE * f = fopen(path, "rb"); 
	if (!f){
		printf("Error: file not found %s %s\n",path,strerror(errno)); 
		exit(1);
	}
	
	fseek( f, 0, SEEK_END );
	int fileSize = ftell( f );
	rewind(f);
	if ( fileSize < sizeof(fileHeader) )
	{
		printf("Illegal file\n");
		fclose(f);
		exit(1);
	}
	char * data = (char*)malloc(fileSize);
	if ( NULL == data )
	{
		printf("Malloc failed\n");
		fclose(f);
		exit(1);
	}
	fread(data, 1, fileSize, f);
	struct fileHeader * fh = (struct fileHeader *)data;
	fh->totalLenght = fileSize;
	fclose(f);
	return fh;
}

void validateFileStruct(struct fileHeader * fh){
	
	if ( fh->magic != MAGIC )
	{
		printf("Illegal magic %x\n",fh->magic);
		free (fh);
		exit(1);
	}

	unsigned int tablesSize = fh->numberOfTables * sizeof(struct tableDesc);
	if (tablesSize > fh->totalLenght){
		printf("Illegl numer of tables %x\n",fh->numberOfTables);
		free(fh);
		exit(1);
	}

	
}


void printMeargedTables(struct fileHeader * fh, unsigned int tag)
{
	int i;
	char size = 0;
	char tableData[MAX_TABLE_SIZE];
	
	
	validateFileStruct(fh);

	for (i =  0; i < fh->numberOfTables; i++ )
	{
		if ((fh->tables[i].size + fh->tables[i].offset) < fh->totalLenght && fh->tables[i].tag == tag )
		{
			size += fh->tables[i].size;
		}
	}
	if ( size >= MAX_TABLE_SIZE )
	{
		return;
	}
	unsigned int offset = 0;
	for (i = 0; i < fh->numberOfTables; i++ )
	{
		if ( fh->tables[i].tag == tag && (fh->tables[i].size + fh->tables[i].offset) < fh->totalLenght )
		{
			memcpy(tableData + offset, (char*)fh + fh->tables[i].offset, fh->tables[i].size);
			offset += fh->tables[i].size;
		}
	}
	
	for ( i = 0; i < size; i++ )
	{
		printf("%x ", tableData[i]);
	}
}


void main()
{
	char s[4];
	struct fileHeader* fh;
	getUserName();
	fh = readFile();
	printMeargedTables(fh, 0x30);
	printf("finished\n");
	
}